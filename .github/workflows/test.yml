name: Run Tests on PR

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  test:
    runs-on: ubuntu-latest
    
    # PostgreSQL ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ (í…ŒìŠ¤íŠ¸ìš© DB)
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: pandamarket_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    # ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    # Node.js ì„¤ì •
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    # ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
    - name: ğŸ” Create .env file
      run: |
        echo "NODE_ENV=test" >> .env
        echo "DATABASE_URL=postgresql://testuser:testpass@localhost:5432/pandamarket_test" >> .env
        echo "JWT_SECRET=test_jwt_secret_key_for_testing" >> .env
        echo "AWS_REGION=ap-northeast-2" >> .env
        echo "S3_BUCKET_NAME=test-bucket" >> .env
    
    # Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    - name: ğŸ—„ï¸ Generate Prisma Client
      run: npx prisma generate
    
    # í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
    - name: ğŸš€ Run database migrations
      run: npx prisma migrate deploy
      env:
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/pandamarket_test
    
    # TypeScript íƒ€ì… ì²´í¬
    - name: ğŸ“ Type check
      run: npx tsc --noEmit
    
    # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: ğŸ§ª Run unit tests
      run: npm run test:unit
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/pandamarket_test
    
    # í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: ğŸ”„ Run integration tests
      run: npm run test:integration
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/pandamarket_test
    
    # ì „ì²´ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
    - name: ğŸ“Š Run all tests with coverage
      run: npm run test:coverage
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/pandamarket_test
    
    # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì½”ë©˜íŠ¸ (PRì— í‘œì‹œ)
    - name: ğŸ’¬ Comment test results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const coverage = fs.existsSync('./coverage/coverage-summary.json') 
            ? JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'))
            : null;
          
          let comment = '## âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼\n\n';
          comment += 'ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
          
          if (coverage && coverage.total) {
            comment += '### ğŸ“Š ì½”ë“œ ì»¤ë²„ë¦¬ì§€\n';
            comment += `- Lines: ${coverage.total.lines.pct}%\n`;
            comment += `- Statements: ${coverage.total.statements.pct}%\n`;
            comment += `- Functions: ${coverage.total.functions.pct}%\n`;
            comment += `- Branches: ${coverage.total.branches.pct}%\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    # ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì €ì¥)
    - name: ğŸ“¤ Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/
        retention-days: 7