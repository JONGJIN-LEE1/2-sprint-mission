name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  # ìˆ˜ë™ ë°°í¬ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  workflow_dispatch:

jobs:
  # í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‹¤í–‰
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: pandamarket_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Create .env file
        run: |
          echo "NODE_ENV=test" >> .env
          echo "DATABASE_URL=postgresql://testuser:testpass@localhost:5432/pandamarket_test" >> .env
          echo "JWT_ACCESS_TOKEN_SECRET=test_jwt_access_secret_key_for_testing" >> .env
          echo "JWT_REFRESH_TOKEN_SECRET=test_jwt_refresh_secret_key_for_testing" >> .env
          echo "AWS_REGION=ap-northeast-2" >> .env
          echo "S3_BUCKET_NAME=test-bucket" >> .env

      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸš€ Run migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/pandamarket_test

      - name: ğŸ§ª Run tests
        run: npm test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/pandamarket_test
          JWT_ACCESS_TOKEN_SECRET: test_jwt_access_secret_key_for_testing
          JWT_REFRESH_TOKEN_SECRET: test_jwt_refresh_secret_key_for_testing

  # ë°°í¬ ì‘ì—…
  deploy:
    needs: test # í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„ì—ë§Œ ë°°í¬
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build TypeScript
        run: npm run build

      - name: ğŸ“‹ Prepare deployment package
        run: |
          # ë°°í¬ íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p deploy-package

          # í•„ìš”í•œ íŒŒì¼ë“¤ ë³µì‚¬
          cp -r build deploy-package/
          cp package*.json deploy-package/
          cp -r prisma deploy-package/
          cp -r public deploy-package/ 2>/dev/null || true
          cp ecosystem.config.js deploy-package/ 2>/dev/null || true
          cp -r src/infra/ec2/ecosystem.config.js deploy-package/ 2>/dev/null || true

          # ì••ì¶• (ì „ì†¡ ì†ë„ í–¥ìƒ)
          tar -czf deploy-package.tar.gz deploy-package/

      - name: ğŸ”‘ Setup SSH
        run: |
          # SSH ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.ssh

          # SSH í‚¤ ì„¤ì •
          echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # SSH ì„¤ì •
          cat >> ~/.ssh/config <<END
          Host ec2-server
            HostName ${{ secrets.AWS_HOST }}
            User ${{ secrets.AWS_USERNAME }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          END

      - name: ğŸš€ Deploy to EC2
        run: |
          # ì••ì¶• íŒŒì¼ ì „ì†¡
          scp deploy-package.tar.gz ec2-server:~/

          # EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh ec2-server << 'ENDSSH'
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨
            
            echo "ğŸ”„ ë°°í¬ ì‹œì‘..."
            
            # ì´ì „ ë°±ì—… ì œê±°
            rm -rf ~/panda-market-backup
            
            # í˜„ì¬ ë²„ì „ ë°±ì—…
            if [ -d ~/panda-market ]; then
              echo "ğŸ“¦ í˜„ì¬ ë²„ì „ ë°±ì—… ì¤‘..."
              cp -r ~/panda-market ~/panda-market-backup
            fi
            
            # ìƒˆ ë²„ì „ ì••ì¶• í•´ì œ
            echo "ğŸ“‚ ìƒˆ ë²„ì „ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf deploy-package.tar.gz
            rm deploy-package.tar.gz
            
            # ë””ë ‰í† ë¦¬ ì´ë™
            rm -rf ~/panda-market-new
            mv deploy-package ~/panda-market-new
            
            cd ~/panda-market-new
            
            # í™˜ê²½ ë³€ìˆ˜ ë¨¼ì € ë³µì‚¬ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ì— í•„ìš”!)
            if [ -f ~/.env.production ]; then
              echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë³µì‚¬ ì¤‘ (í™ˆ ë””ë ‰í† ë¦¬)..."
              cp ~/.env.production ~/panda-market-new/.env.production
            elif [ -f ~/panda-market/.env.production ]; then
              echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë³µì‚¬ ì¤‘ (ì´ì „ ë²„ì „)..."
              cp ~/panda-market/.env.production ~/panda-market-new/.env.production
            elif [ -f ~/panda-market/.env ]; then
              cp ~/panda-market/.env ~/panda-market-new/.env
            fi
            
            # í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci --production
            
            # Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            echo "ğŸ—„ï¸ Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì¤‘..."
            npx prisma generate
            
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/panda-market-new/logs
            
            # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
            echo "ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘..."
            cd ~/panda-market-new
            npx prisma migrate deploy || {
              echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨! ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±..."
              rm -rf ~/panda-market-new
              if [ -d ~/panda-market-backup ]; then
                mv ~/panda-market-backup ~/panda-market
              fi
              exit 1
            }
            
            # ìƒˆ ë²„ì „ìœ¼ë¡œ êµì²´
            echo "ğŸ”„ ìƒˆ ë²„ì „ìœ¼ë¡œ êµì²´ ì¤‘..."
            if [ -d ~/panda-market ]; then
              rm -rf ~/panda-market
            fi
            mv ~/panda-market-new ~/panda-market
            
            cd ~/panda-market
            
            # ecosystem.config.js íŒŒì¼ í™•ì¸ ë° ì‚¬ìš©
            if [ -f src/infra/ec2/ecosystem.config.js ]; then
              cp src/infra/ec2/ecosystem.config.js ecosystem.config.js
            fi
            
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
            echo "ğŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ ì¤‘..."
            pm2 stop pandamarket-api 2>/dev/null || true
            pm2 delete pandamarket-api 2>/dev/null || true
            pm2 start ecosystem.config.js --env production
            pm2 save
            
            # í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
            sleep 5
            pm2 status pandamarket-api
            
            # ë¡œê·¸ í™•ì¸ (ìµœê·¼ 20ì¤„)
            echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸:"
            pm2 logs pandamarket-api --lines 20 --nostream
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ“Š PM2 ìƒíƒœ:"
            pm2 list
            
            # ì •ë¦¬
            rm -rf ~/panda-market-backup
          ENDSSH

      - name: ğŸ¥ Health Check
        run: |
          echo "ì„œë²„ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          sleep 10

          # HTTP í—¬ìŠ¤ ì²´í¬ (í¬íŠ¸ 3000)
          max_attempts=5
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.AWS_HOST }}:3000/health 2>/dev/null | grep -q "200\|404"; then
              echo "âœ… ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
              break
            else
              echo "â³ ëŒ€ê¸° ì¤‘... (ì‹œë„ $attempt/$max_attempts)"
              sleep 5
              attempt=$((attempt + 1))
            fi
          done

          if [ $attempt -gt $max_attempts ]; then
            echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ - ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -rf ~/.ssh/deploy_key
          rm -f deploy-package.tar.gz
